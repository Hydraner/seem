<?php

/**
 * @file
 * Contains hook implementations and functions for the seem module.
 */

use Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use Drupal\Core\Entity\EntityInterface;

/**
 * Implements hook_entity_view_alter().
 *
 * Wraps any entity with the seem render element to make it displaybale.
 */
function seem_entity_view_alter(array &$build, EntityInterface $entity, EntityViewDisplayInterface $display) {
  $main_content = $build;
  $build = array(
    '#' . $entity->getEntityTypeId() => $entity,
    '#entity_type' => $entity->getEntityTypeId(),
    'content' => array(
      '#type' => 'seem',
      '#displayable' => 'entity',
      '#main_content' => $main_content,
      '#entity_type' => $entity->getEntityTypeId(),
      '#bundle' => $display->getTargetBundle(),
      '#view_mode' => $display->getMode(),
    ),
  );
}

/**
 * Implements hook_entity_view_alter().
 *
 * Add a post_render callback to any form, in order to wrap the rendered form
 * with a layout.
 */
function seem_form_alter(&$form, $form_state) {
  $form['#post_render'][] = 'seem_post_render';
}

/**
 * Implementation of seem_post_render().
 *
 * Wrap the rendered form with the seem render element to make it displaybale.
 *
 * @param string $markup
 *    The markup passed by post_render. We use it as main_content.
 * @param array $element
 *    The original render array to extract some context.
 *
 * @return string
 *    Returns the rendered layout / new markup.
 */
function seem_post_render($markup, $element) {
  $output = array(
    '#type' => 'seem',
    '#displayable' => 'form',
    '#form_id' => $element['#form_id'],
    '#main_content' => array('#markup' => $markup),
  );
  // @todo: Find a better solution for that.
  return \Drupal::service('renderer')->render($output, FALSE);
}

/**
 * Implements hook_preprocess_HOOK().
 *
 * Since template_preprocess_view removes the views title by default, we add
 * a possibility to show it anyways based on the `show_titleÂ´ parameter.
 */
function seem_preprocess_views_view(&$variables) {
  $view = $variables['view'];

  // Render title if requested.
  if (isset($view->element['#show_title'])) {
    $variables['title']['#markup'] = $view->getTitle();
  }
}
