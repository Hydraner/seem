<?php

/**
 * @file
 * Contains hook implementations and functions for the seem module.
 */

/**
 * Implements hook_entity_view_alter().
 */
function seem_entity_view_alter(array &$build, Drupal\Core\Entity\EntityInterface $entity, \Drupal\Core\Entity\Display\EntityViewDisplayInterface $display) {
  $build['#theme_wrappers'][] = 'seem_wrapper';
}

/**
 * Implements hook_theme().
 */
function seem_theme($existing, $type, $theme, $path) {
  return array(
    'seem_wrapper' => array(
      'render element' => 'content',
      'template' => 'layout/seem-wrapper',
      'children' => array(),
    ),
    'layout' => array(
      'render element' => 'region',
      'template' => 'layout/layout',
      'regions' => array(),
    ),
  );
}

/**
 * Implementation of template_preprocess_seem_wrapper().
 */
function seem_preprocess_seem_wrapper(&$variables) {
//  $layout_plugin_manager = Layout::layoutPluginManager();
  $plugin_manager = \Drupal::service('plugin.manager.seem_layout_plugin');
  $debug = 1;

  if (isset($variables['content']['#node'])) {
    $context = $variables['content'];
    $variables['content'] = array();

    foreach ($plugin_manager->getDefinitions() as $region => $definition) {
      $debug = 1;
      $id = $definition['id'];
      $variables['content'][$region]['#theme_wrappers'][] = 'region';
      $variables['content'][$region]['#region'] = $id;
      foreach ($definition['content'] as $content) {
        if ($content['type'] == 'context') {
          $variables['content'][$region]['context'] = $context;
        }
        else if ($content['type'] == 'markup') {
          $variables['content'][$region]['random']['#markup'] = $content['markup'];
        }
      }
    }
  }
  else {
    $variables['content'] = $variables['content']['#children'];
  }
}
